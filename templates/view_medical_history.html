{% extends 'layout.html' %}

{% block content %}
<div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-3">
    <h2 class="text-3xl font-bold text-[#2d5a2f]">
        Medical History: {{ patient.first_name }} {{ patient.last_name }} (UHID: {{ patient.uhid }})
    </h2>
    {% if role == 'nurse' %}
    <a href="{{ url_for('dashboard', uhid=patient.uhid) }}" 
       class="bg-gray-500 hover:bg-gray-600 text-white text-base font-semibold py-1.5 px-3 rounded-md shadow-sm transition duration-150 ease-in-out flex items-center">
        <i class="fa-solid fa-arrow-left" style="font-size:18px; color:white; margin-right: 8px;"></i>
         Back to Dashboard
    </a>
    {% else %}
    <a href="{{ url_for('view_patient', uhid=patient.uhid) }}"
        class="bg-gray-500 hover:bg-gray-600 text-white text-base font-semibold py-1.5 px-3 rounded-md shadow-sm transition duration-150 ease-in-out flex items-center">
        <i class="fa-solid fa-arrow-left" style="font-size:18px; color:white; margin-right: 8px;"></i>
         Back to Patient Details
    </a>
    {% endif %}
</div>

<div class="bg-white p-6 rounded-lg shadow-xl border border-gray-200">
    
    <div class="bg-gray-100 shadow rounded-lg p-4 mb-8 border border-gray-300">
        <h3 class="text-xl font-bold text-[#3a86d7] mb-3 border-b pb-2">Patient Demographics</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-gray-700">
            <p><strong>D.O.B:</strong> {{ patient.dob | default('N/A') }}</p>
            <p><strong>Gender:</strong> {{ patient.gender | default('N/A') }}</p>
            <p class="col-span-2"><strong>Contact:</strong> {{ patient.phone | default('N/A') }}</p>
            <p class="col-span-full"><strong>Address:</strong> {{ patient.address | default('N/A') }}</p>
        </div>
    </div>
    
    <h3 class="text-2xl font-bold text-[#2d5a2f] mb-4">Historical Medical Records</h3>
    
    {% if medical_records %}
        <div class="space-y-8">
            {% for record in medical_records %}
                <div class="bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <p class="font-bold text-xl text-[#3a86d7]">Visit Date: {{ record.visit_date.strftime('%Y-%m-%d') if record.visit_date else 'N/A' }}</p>
                    </div>
                    
                    <p class="text-gray-700 mb-2"><strong>Diagnosis:</strong> {{ record.diagnosis | default('N/A') }}</p>
                    <p class="text-gray-700 mb-4"><strong>Treatment:</strong> {{ record.treatment | default('N/A') }}</p>
                    
                    <div class="text-gray-700 border-t pt-4">
                        <h4 class="font-bold text-lg text-gray-800 mb-2">Test Results:</h4>
                        
                        {% set test_results = record.test_results | default({}) %}
                        
                        {% if test_results.raw_text is defined %}
                            <div class="bg-red-50 p-3 rounded-md text-sm mt-1 border border-red-200">
                                <div class="font-semibold text-red-800 border-b border-red-200 pb-1 mb-2">Warning: Unstructured/Legacy Test Results</div>
                                <p class="text-red-700">{{ test_results.raw_text }}</p>
                            </div>
                        {% elif test_results and test_results|length > 0 %}
                            {% set parsed_test_results = test_results %}
                            <div class="bg-white p-3 rounded-md text-sm mt-1 space-y-2 border">
                                
                                {# --- VISUAL ACUITY --- #}
                                {% if parsed_test_results.VA_OD is defined or parsed_test_results.VA_OS is defined or parsed_test_results.VA_OD_with_correction is defined or parsed_test_results.VA_OS_with_correction is defined %}
                                <div class="font-semibold text-[#3a86d7] border-b border-gray-200 pb-1">Visual Acuity</div>
                                <div class="grid grid-cols-2 gap-x-4">
                                    {% if parsed_test_results.VA_OD is defined %}<p><strong>VA OD:</strong> {{ parsed_test_results.VA_OD }}</p>{% endif %}
                                    {% if parsed_test_results.VA_OS is defined %}<p><strong>VA OS:</strong> {{ parsed_test_results.VA_OS }}</p>{% endif %}
                                    {% if parsed_test_results.VA_OD_with_correction is defined %}<p><strong>VA OD (c.c.):</strong> {{ parsed_test_results.VA_OD_with_correction }}</p>{% endif %}
                                    {% if parsed_test_results.VA_OS_with_correction is defined %}<p><strong>VA OS (c.c.):</strong> {{ parsed_test_results.VA_OS_with_correction }}</p>{% endif %}
                                </div>
                                {% endif %}

                                {# --- IOP --- #}
                                {% if parsed_test_results.IOP_OD is defined or parsed_test_results.IOP_OS is defined %}
                                <div class="font-semibold text-[#3a86d7] border-b border-gray-200 pb-1 pt-2">Intraocular Pressure</div>
                                <div class="grid grid-cols-2 gap-x-4">
                                    {% if parsed_test_results.IOP_OD is defined %}<p><strong>IOP OD:</strong> {{ parsed_test_results.IOP_OD }} mmHg</p>{% endif %}
                                    {% if parsed_test_results.IOP_OS is defined %}<p><strong>IOP OS:</strong> {{ parsed_test_results.IOP_OS }} mmHg</p>{% endif %}
                                </div>
                                {% endif %}
                                
                                {# --- REFRACTION --- #}
                                {% if parsed_test_results.Refraction_OD_Sph is defined or parsed_test_results.Refraction_OD_Cyl is defined or parsed_test_results.Refraction_OD_Ax is defined or parsed_test_results.Refraction_OS_Sph is defined or parsed_test_results.Refraction_OS_Cyl is defined or parsed_test_results.Refraction_OS_Ax is defined %}
                                <div class="font-semibold text-[#3a86d7] border-b border-gray-200 pb-1 pt-2">Refraction</div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                                    {% if parsed_test_results.Refraction_OD_Sph is defined or parsed_test_results.Refraction_OD_Cyl is defined or parsed_test_results.Refraction_OD_Ax is defined %}
                                    <p><strong>OD:</strong> Sph {{ parsed_test_results.Refraction_OD_Sph | default('N/A') }}, Cyl {{ parsed_test_results.Refraction_OD_Cyl | default('N/A') }}, Ax {{ parsed_test_results.Refraction_OD_Ax | default('N/A') }}</p>
                                    {% endif %}
                                    {% if parsed_test_results.Refraction_OS_Sph is defined or parsed_test_results.Refraction_OS_Cyl is defined or parsed_test_results.Refraction_OS_Ax is defined %}
                                    <p><strong>OS:</strong> Sph {{ parsed_test_results.Refraction_OS_Sph | default('N/A') }}, Cyl {{ parsed_test_results.Refraction_OS_Cyl | default('N/A') }}, Ax {{ parsed_test_results.Refraction_OS_Ax | default('N/A') }}</p>
                                    {% endif %}
                                </div>
                                {% endif %}

                                {# --- SLE --- #}
                                {% if parsed_test_results.SLE_OD_Cornea is defined or parsed_test_results.SLE_OS_Cornea is defined or parsed_test_results.SLE_OD_Lens is defined or parsed_test_results.SLE_OS_Lens is defined %}
                                <div class="font-semibold text-[#3a86d7] border-b border-gray-200 pb-1 pt-2">Slit Lamp Exam</div>
                                <div class="grid grid-cols-2 gap-x-4">
                                    {% if parsed_test_results.SLE_OD_Cornea is defined %}<p><strong>Cornea OD:</strong> {{ parsed_test_results.SLE_OD_Cornea }}</p>{% endif %}
                                    {% if parsed_test_results.SLE_OS_Cornea is defined %}<p><strong>Cornea OS:</strong> {{ parsed_test_results.SLE_OS_Cornea }}</p>{% endif %}
                                    {% if parsed_test_results.SLE_OD_Lens is defined %}<p><strong>Lens OD:</strong> {{ parsed_test_results.SLE_OD_Lens }}</p>{% endif %}
                                    {% if parsed_test_results.SLE_OS_Lens is defined %}<p><strong>Lens OS:</strong> {{ parsed_test_results.SLE_OS_Lens }}</p>{% endif %}
                                </div>
                                {% endif %}

                                {# --- FUNDUS --- #}
                                {% if parsed_test_results.Fundus_OD is defined or parsed_test_results.Fundus_OS is defined %}
                                <div class="font-semibold text-[#3a86d7] border-b border-gray-200 pb-1 pt-2">Fundus Exam</div>
                                <div class="grid grid-cols-2 gap-x-4">
                                    {% if parsed_test_results.Fundus_OD is defined %}<p><strong>Fundus OD:</strong> {{ parsed_test_results.Fundus_OD }}</p>{% endif %}
                                    {% if parsed_test_results.Fundus_OS is defined %}<p><strong>Fundus OS:</strong> {{ parsed_test_results.Fundus_OS }}</p>{% endif %}
                                </div>
                                {% endif %}
                                
                            </div>
                        {% else %}
                            <p>No specific test results recorded for this visit.</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
    <div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-200">
        <p class="text-blue-800">No medical records found for this patient.</p>
    </div>
    {% endif %}

    <hr class="my-8 border-gray-300">
    
    <h3 class="text-2xl font-bold text-[#2d5a2f] mb-4 mt-8">Historical Prescriptions</h3>

    {% if prescriptions %}
        <div class="space-y-8">
            {% for rx in prescriptions %}
                <div class="bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h4 class="font-bold text-lg text-gray-800">Prescription Record</h4>
                    </div>
                    
                    <p class="text-gray-600 mb-2"><strong>Prescribed On:</strong> {{ rx.created_at.strftime('%Y-%m-%d %H:%M:%S') if rx.created_at else 'N/A' }}</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 border p-3 rounded-md bg-white">
                            <h5 class="font-semibold text-sm mb-1 text-blue-700">Refraction/Spectacle Data:</h5>
                            <p>OD: SPH: {{ rx.spectacle_data.od_sph | default('N/A') }}, CYL: {{ rx.spectacle_data.od_cyl | default('N/A') }}, AXIS: {{ rx.spectacle_data.od_axis | default('N/A') }}, ADD: {{ rx.spectacle_data.od_add | default('N/A') }}</p>
                            <p>OS: SPH: {{ rx.spectacle_data.os_sph | default('N/A') }}, CYL: {{ rx.spectacle_data.os_cyl | default('N/A') }}, AXIS: {{ rx.spectacle_data.os_axis | default('N/A') }}, ADD: {{ rx.spectacle_data.os_add | default('N/A') }}</p>
                            <p class="mt-2"><strong>Lens Type:</strong> {{ rx.lens_type | default('N/A') }}</p>
                        </div>
                        
                        <p class="col-span-2"><strong>Medications:</strong> {{ rx.medications_text | default('N/A') }}</p>
                        
                        <p class="col-span-2"><strong>Systemic Medication:</strong> {{ rx.systemic_medication | default('N/A') }}</p>
                        
                        <p><strong>Follow-up:</strong> {{ rx.follow_up_date.strftime('%Y-%m-%d') if rx.follow_up_date else 'N/A' }}</p>
                        
                        {% if rx.surgery_recommendation %}
                        <p class="col-span-2 text-red-600 font-semibold"><strong>Surgery Recommended:</strong> {{ rx.surgery_recommendation }}</p>
                        {% endif %}
                        
                        <p class="col-span-2 text-gray-700 mt-2"><strong>Instructions:</strong> {{ rx.patient_instructions | default('N/A') }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
    <div class="bg-yellow-50 p-4 rounded-lg shadow-sm border border-yellow-200">
        <p class="text-yellow-800">No prescriptions found for this patient.</p>
    </div>
    {% endif %}
    
    {% if role == 'nurse' %}
    <a href="{{ url_for('dashboard', uhid=patient.uhid) }}" class="mt-6 inline-block text-[#3a86d7] hover:underline font-semibold">← Back to Dashboard</a>
    {% else %}
    <a href="{{ url_for('view_patient', uhid=patient.uhid) }}" class="mt-6 inline-block text-[#3a86d7] hover:underline font-semibold">← Back to Current Patient Record</a>
    {% endif %}
</div>

{% include 'flash_messages.html' %}

{% endblock %}